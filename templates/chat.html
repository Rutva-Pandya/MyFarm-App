<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CropWizard</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
            background-color: #E84A27;
            color: #333;
        }

        .header {
            display: flex;
            justify-content: space-between; /* Updated this line */
            align-items: center;
            background-color: #E84A27;
            color: #fff;
            padding: 10px 20px;
            font-size: 24px;
        }

        .back-button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background-color: #13294B;
            color: white;
            cursor: pointer;
            margin-left: 5px;
        }

        .chat-container {
            padding: 20px;
            height: calc(100vh - 200px);
            overflow-y: auto;
            background-color: #f2f2f2;
            display: flex;
            flex-direction: column-reverse;
        }

        .input-box {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 10px;
            background-color: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid #E84A27;
        }

        .input-box > input[type="text"] {
            flex-grow: 1;
            margin-right: 10px;
            padding: 10px;
            border: 1px solid #E84A27;
            border-radius: 5px;
        }

        .input-box > button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background-color: #13294B;
            color: white;
            cursor: pointer;
            margin-left: 5px;
        }

        .input-box > button:hover {
            background-color: #E84A27;
        }

        .chat-message {
            padding: 10px 20px;
            border-radius: 20px;
            margin: 5px 0;
            max-width: 80%;
            word-wrap: break-word;
        }

        .user-message {
            background-color: #007bff;
            color: white;
            align-self: flex-end;
            margin-right: 20px;
        }

        .wizard-message {
            background-color: #f8f9fa;
            color: #333;
            align-self: flex-start;
            margin-left: 20px;
        }

    </style>
</head>
<body>
    <div class="header">
        <div class="title">CropWizard</div>
        <button class="back-button" onclick="window.history.back();">&#x2190; Back</button>
    </div>
    <div class="chat-container" id="chat-container">
        <!-- Chat messages will appear here -->
    </div>
    <div class="input-box">
        <input type="text" id="text-input" placeholder="Type a message or use the 'Upload Image' button...">
        <input type="file" id="image-input" accept="image/*" style="display: none;">
        <button onclick="document.getElementById('image-input').click();">Upload Image</button>
        <!-- Remove Image button, hidden by default -->
        <button id="remove-image" style="display: none;" onclick="removeImage()">Remove Image</button>
        <button onclick="sendQuery()">Send</button>
    </div>
    <script>
        document.getElementById('image-input').onchange = function(event) {
            if(event.target.files.length > 0) {
                // Show the remove image button when an image is chosen
                document.getElementById('remove-image').style.display = 'inline';
            }
            // Optionally, you can handle the image file here
            // sendQuery();
        };

        function sendQuery() {
            var formData = new FormData();
            var textInput = document.getElementById('text-input');
            var fileInput = document.getElementById('image-input');
            var chatContainer = document.getElementById('chat-container');

            // Append user message to chat
            if (textInput.value.trim() || fileInput.files.length) {
                appendMessage('You: ' + (textInput.value.trim() ? textInput.value : 'Image uploaded.'), 'user-message');
            }

            // Only proceed if there is text or a file
            if (textInput.value.trim() || fileInput.files.length) {
                if (fileInput.files[0]) {
                    formData.append('file', fileInput.files[0]);
                } else {
                    formData.append('text', textInput.value);
                }

                fetch('/ask_cropwizard', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    appendMessage('CropWizard: ' + data.response, 'wizard-message');
                    textInput.value = ''; // Clear the text input
                    fileInput.value = ''; // Clear the file input
                    document.getElementById('remove-image').style.display = 'none'; // Hide remove image button
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            }
        }

        function appendMessage(message, className) {
            var chatContainer = document.getElementById('chat-container');
            var messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message ' + className;
            messageDiv.innerHTML = message;
            chatContainer.prepend(messageDiv); // Add the message to the top of the chat container
        }

        function removeImage() {
            var fileInput = document.getElementById('image-input');
            fileInput.value = ''; // Clear the file input
            document.getElementById('remove-image').style.display = 'none'; // Hide the remove button
        }
    </script>
</body>
</html>